#  Probabilidades elementales: Aplicaciones en medicina

En medicina, las probabilidades (recordad, las proporciones de sujetos de una población con una determinada característica) aparecen bajo diferentes términos. Por ejemplo:

* **Riesgo** de algo: La probabilidad de que pase ese algo (usualmente negativo, por la connotación de la palabra "riesgo").

* **Prevalencia** de algo: La probabilidad de que un individuo de una población tenga ese algo en un momento determinado.

* **Tasa** de algo: Sinónimo de la "proporción" o la "fracción" de ese algo en algún total. Por ejemplo:

    * La **tasa de mortalidad** de una enfermedad es la proporción de individuos de una población que mueren a causa de esa enfermedad en un período determinado de tiempo, y por tanto la probabilidad de que un individuo de esa población muera por esa enfermedad en ese período.
    
    * La **tasa de letalidad** de una enfermedad es la proporción de enfermos (de esa enfermedad, se entiende) en una población que mueren a causa de esa enfermedad en un período determinado de tiempo, y por tanto la probabilidad de que un enfermo muera por esa enfermedad en ese período.
    
    * Al hablar de incidencia, a veces se usa el término **tasa de incidencia** de una enfermedad para significar la proporción de casos nuevos de esa enfermedad en una población (sana) en un cierto periodo de tiempo, y por lo tanto es la probabilidad de que un individuo sano  coja esa enfermedad durante ese período.
    

```{example}
En el artículo ["Incidencia, prevalencia y mortalidad del cáncer renal en España: estimaciones y proyecciones para el período 1998-2022"](https://www.sciencedirect.com/science/article/pii/S0210480611003767) (*Actas Urológicas Españolas* 36 (2012), pp. 521-526) se puede leer:

```


> En hombres se espera un aumento de la tasa de incidencia [del cáncer de riñón] de 11.92 casos por 100000 habitantes/año a 15.7. La prevalencia aumentaría de 72.842  a 94.47 y la mortalidad de 5.77 a 7.29. 


En todos los casos se trata de estimaciones de  probabilidades. Se estima que:

* La probabilidad de que un hombre sano enfermara de cáncer de riñón en 1998 fue de 0.0001192 y en 2022 será de 0.000157.

* La probabilidad de que un hombre tuviera cáncer de riñón en 1998 fue de  0.00072842  y  en 2022 será  de 0.0009447.

* La probabilidad de que un hombre muriera de cáncer de riñón en 1998 fue de  0.0000577  y  en 2022 será  de 0.0000729.
    
```{block2,type="rmdexercici"}
Leído en el [MallorcaDiario.com](https://www.mallorcadiario.com/mortalidad-coronavirus-baleares-tasa): "La tasa de mortalidad a causa del COVID-19 en Baleares fue del 1.06 por ciento frente al 2.17 por ciento a nivel nacional [...]. En el caso de personas mayores de 74, la tasa de mortalidad de Baleares (12.74 por ciento) está casi diez puntos porcentuales por debajo que la media nacional de personas de a misma edad, que llegó hasta el 22,34 por ciento."

¿De qué están hablando realmente, de la tasa de mortalidad de la COVID-19 o de su tasa de letalidad?
```




## Pruebas diagnósticas


Una **prueba diagnóstica** es cualquier tecnología que pueda servir para detectar un signo que se relacione con la patología de interés. Por ejemplo, un test de embarazo, una determinación del nivel de un marcador tumoral, una prueba PCR para el SARS-COV-2, etc.

En la práctica, se suelen distinguir dos tipos de pruebas diagnósticas, de las que se esperan capacidades diagnósticas diferentes:

* **Test de cribado**: se realiza sobre individuos asintomáticos, con el objetivo principal de descartar que tengan la enfermedad.

* **Test diagnóstico**: se realiza en individuos que muestran síntomas o que han dado positivo en un test de cribado, con el objetivo principal de detectar la presencia de la enfermedad.

Por ejemplo, distinguiríamos entre las *mamografías de cribado*  que se realizan periódicamente a las mujeres a partir de una cierta edad, y las *mamografías diagnósticas* que se realizan a las mujeres que han detectado un bulto en un seno.  
 
Tanto en un caso como el otro, el objetivo de una prueba diagnóstica es diagnosticar una enfermedad. Por ahora vamos a considerar que nuestra prueba es **binaria**, en el sentido de que da solo dos resultados posibles: positivo o negativo. Lo deseable sería entonces que:

* El resultado de la prueba sea positivo exactamente cuando el paciente tiene la enfermedad.

* El resultado de la prueba sea negativo exactamente cuando el paciente no tiene la enfermedad.

Por desgracia, casi nunca se tiene una prueba diagnóstica cien por cien segura en este sentido. Ni tan solo para detectar si un individuo está muerto o no, por lo que parece. Por lo tanto, habrá que evaluar y describir la probabilidad que tiene una prueba de acertar.


```{r elcomercio, echo=FALSE, out.width="60%", fig.cap="Noticia aparecida en  El Comercio el 8/01/2018: https://www.elcomercio.es/asturias/preso-dado-muerto-20180108012648-ntvo.html."}
knitr::include_graphics("INREMDN_files/figure-html/lazaro1.png")
```

### Sensibilidad, especificidad, valores predictivos etc.


Vamos a poner algunos nombres a sucesos. En una prueba diagnóstica, tenemos dos tipos de sucesos:

* El **resultado del test**: $+$, positivo, o $-$, negativo. Como suponemos que la prueba es binaria,  $-$ es el complementario de $+$.

* El  **estado del sujeto**:  $S$, sano, o  $E$, enfermo. $S$ es el complementario de $E$, no hay términos medios.

```{block2,type="rmdnote"}
Es importante tener en cuenta que la clasificación de un sujeto en Enfermo o Sano usualmente se lleva a cabo mediante una prueba de referencia (*gold standard*), que no siempre existe y que cuando existe, puede dar (eso sí, muy raramente) diagnósticos erróneos. Nosotros vamos a suponer que siempre existe y siempre acierta, de manera que podemos comparar nuestra prueba diagnóstica con la "realidad" del paciente.
```


Podemos clasificar los sujetos de la población según estos dos pares de sucesos complementarios:

$$
\begin{array}{l}
\hphantom{TestTestTest}\textbf{Enfermedad} \\
\begin{array}{c|c|c}
\textbf{Test}  & E & S \\ \hline
+ & \text{Verdaderos} & \text{Falsos} \\[-0.5ex]  	
 & \text{positivos} & \text{positivos} \\ \hline
- & \text{Falsos} & \text{Verdaderos} \\[-0.5ex]   	
 & \text{negativos} & \text{negativos}
\end{array}
\end{array}
$$
Por ejemplo, el pobre preso de la noticia de la Figura \@ref(fig:elcomercio) fue un falso positivo.

Entonces, para una prueba diagnóstica:

* Su **sensibilidad** es la probabilidad de que dé positivo sobre un individuo enfermo. Es decir, $P(+|E)$.

* Su **tasa de falsos negativos** es la probabilidad de que dé negativo sobre un individuo enfermo. Es decir, $P(-|E)$.

* Su **especificidad** es la probabilidad de que dé negativo sobre un individuo sano. Es decir, $P(-|S)$.

* Su **tasa de falsos positivos** es la probabilidad de que dé positivo sobre un individuo sano. Es decir, $P(+|S)$.

Observad que

*  La Tasa de falsos negativos es  1 menos la Sensibilidad: $P(-|E)=1-P(+|E)$.

*  La Tasa de falsos positivos es  1 menos la Especificidad: $P(+|S)=1-P(-|S)$.

```{block2,type="rmdnote"}
Igual os es útil la regla mnemotécnica siguiente, para recordar qué es la sensibilidad y qué la especificidad:

* La Se**N**sibilidad es  1 menos la Tasa de falsos **N**egativos.

* La Es**P**ecificidad es  1 menos la Tasa de falsos **P**ositivos

```


```{example}
Recordad el Ejemplo \@ref(exm:VIH995), en el que teníamos un test para el VIH que daba positivo en  un 99% de las personas en las que el virus está presente y en un 5% de las personas en las que el virus no está presente.

* La **sensibilidad** de este test es la proporción de enfermos en los que da positivo: 99%.

* La **especificidad**  de este test es la proporción de sanos en los que da negativo: 95%.

* Y entonces, ¿qué es el 5%? Su **tasa de falsos positivos**: la proporción de sanos en los que da positivo.


```
 

Algunas definiciones más. Para una prueba diagnóstica:

* Su **valor predictivo positivo** (**VPP**)  es la probabilidad de que, si da positivo, el individuo esté enfermo. Es decir, $P(E|+)$.

* Su **valor predictivo negativo** (**VPN**)  es la probabilidad de que, si da negativo, el individuo esté sano. Es decir, $P(S|-)$.


Normalmente conocemos estimaciones de la sensibilidad y la especificidad de una prueba, obtenidas tomando una muestra de sanos y una de enfermos y pasándoles la prueba para ver cuántos dan positivo y cuántos negativo (**Ejercicio**: ¿De qué tipo de estudio se trata?). Entonces, como hemos visto en la sección sobre la fórmula de Bayes de la lección anterior, conociendo la prevalencia $P(E)$ de la enfermedad, podemos calcular los valores predictivos a partir de la especificidad y sensibilidad. 

Por ejemplo, recordad el enunciado (ahora completo) del Ejemplo \@ref(exm:VIH995):

> Un test para el VIH da positivo en un 99% de las personas en las que el virus está presente y en un 5% de las personas en las que el virus no está presente. En una población con el 0.5% de infectados por VIH, ¿cuál es la probabilidad de que un individuo que haya dado positivo en el test esté infectado? ¿Y cuál es la probabilidad de que un individuo que haya dado negativo en el test no esté infectado?

Su traducción en la terminología introducida al principio de esta sección es:

> Un test para el VIH tiene una sensibilidad del 99% y una especificidad del 95%. En una población con una prevalencia del VIH del 0.5%, ¿cuáles son los VPP y VPN del test?

Este tipo de cuestiones se pueden resolver usando el método de  frecuencias naturales o, si os gusta recordar fórmulas, directamente la fórmula de Bayes:
$$
\begin{array}{l}
\text{VPP} = P(E|+) =\dfrac{P(+|E)\cdot P(E)}{P(+|E)\cdot P(E)+P(+|S)\cdot P(S)}\\
\qquad =\dfrac{\text{sensibilidad}\cdot \text{prevalencia}}{\text{sensibilidad}\cdot \text{prevalencia}+(1-\text{especificidad})(1-\text{prevalencia})}\\[2ex]
\text{VPN} = P(S|-)=\dfrac{P(-|S)\cdot P(S)}{P(-|S)\cdot P(S)+P(-|E)\cdot P(E)}\\
\qquad =\dfrac{\text{especificidad}\cdot (1-\text{prevalencia})}{\text{especificidad}\cdot (1-\text{prevalencia})+(1-\text{sensibilidad})\cdot\text{prevalencia}}
\end{array}
$$

```{example, antiendomisio}
En el artículo ["Sensibilidad y especificidad de los exámenes de anticuerpos antigliadina y antiendomisio"](http://www.scielo.edu.uy/scielo.php?pid=S1688-12492002000200003&script=sci_arttext&tlng=en) (W. Lozano *et al*, *Archivos de Pediatría del Uruguay* 73 (2002), pp. 69-73) se examinaron la sensibilidad y la especificidad de dos técnicas analíticas en el diagnóstico de la enfermedad celíaca en niños. Participaron en el estudio 65 niños: 15 celíacos y 50 que no lo eran. En el artículo se incluye la tabla que copiamos en la Figura \@ref(fig:espe2), donde los enfermos se clasifican en celíacos y no celíacos mediante el diagnóstico de referencia, una biopsia de intestino delgado.

*(a)* Suponiendo que los resultados son representativos de la población infantil, ¿qué estimamos que valen la especificidad y la sensibilidad de cada una de las dos pruebas de anticuerpos estudiadas?

*(b)* Uno de cada 64 niños del Uruguay (donde se realizó este estudio) es celíaco. ¿Qué estimamos que valen el VPP y VPN de cada una de las dos pruebas de anticuerpos estudiadas para los niños uruguayos?

*(c)* En España, 1 de cada 71 niños es celíaco. ¿Qué estimamos que valen el VPP y VPN  de cada una de las dos pruebas de anticuerpos estudiadas para los niños españoles?


```



```{r espe2,echo=FALSE, out.width="90%",fig.cap="Tabla 1 en el artículo \"Sensibilidad y especificidad de los exámenes de anticuerpos antigliadina y antiendomisio\"." }
knitr::include_graphics("INREMDN_files/figure-html/espe2.png")
```


Vamos a responder las preguntas para la prueba de anticuerpos antiendomisio, os dejamos la otra como **ejercicio**.

Para la  prueba de anticuerpos antiendomisio, tenemos la tabla de frecuencias siguiente, obtenida de la de la derecha de la figura anterior:
$$
\begin{array}{r|cc|c}
& \text{Celíacos}\ (E) & \text{No celíacos}\ (S) & \text{Total} \\ \hline
+ & 47 & 1 & 48  \\  
- & 3 & 14 & 17 \\ \hline
\text{Total} & 50  & 15 & 65  
\end{array}
$$

*(a)* Estimamos que:

* La **sensibilidad** es $P(+|E)=47/50=0.94$

* La **especificidad** es $P(-|S)= 14/15=0.9333$

Es decir, 

* El test da positivo en un 94% de los celíacos.
* El test da negativo en un 93.33% de los no celíacos.

*(b)* En primer lugar vamos a calcular los valores predictivos usando la fórmula de Bayes. Como $P(+|E)=0.94$, $P(-|S)=14/15$ y en Uruguay $P(E)=1/64$, por lo que $P(S)=63/64$:

$$
\begin{array}{rl}
\text{VPP}\!\!\!\! & =P(E|+)=\dfrac{P(+|E)\cdot P(E)}{P(+|E)\cdot P(E)+P(+|S)\cdot P(S)}\\
&= \dfrac{0.94\cdot \frac{1}{64}}{0.94\cdot \frac{1}{64}+\frac{1}{15}\cdot \frac{63}{64}}=0.1829\\[1ex]
\text{VPN} \!\!\!\!& =P(S|-)=\dfrac{P(-|S)\cdot P(S)}{P(-|S)\cdot P(S)+P(-|E)\cdot P(E)}\\
&= \dfrac{\frac{14}{15}\cdot \frac{63}{64}}{\frac{1}{15}\cdot \frac{63}{64}+0.06\cdot \frac{1}{64}}=0.999
\end{array}
$$

Es decir, 

* Estimamos que un 18.29% de los niños uruguayos que dan positivo en el test son celíacos.
* Estimamos que un 99.9% de los niños uruguayos que dan negativo en el test no son celíacos.

Vamos a repetir el cálculo usando frecuencias naturales. Para que nos salgan números redondos, vamos a partir de una población de referencia de 640,000 niños uruguayos.

* Un 1/64 son celíacos, 10,000. Los 630,000 restantes no lo son.
* De los 10,000 celíacos, un 94% dan positivo. Por lo tanto, 9,400 dan positivo y 600 negativo.
* De los 630,000 no celíacos, 14 de cada 15 dan negativo Por lo tanto, 588,000 dan negativo y 42,000 positivo.

En resumen:
$$
\begin{array}{r|c|c|c}
& \text{Celíacos} & \text{No celíacos}  & \text{Total} \\ \hline
+ & 9400  &  42000 &  51400 \\ \hline
- & 600  & 588000 &  588600  \\ \hline
\text{Total} &  10000 & 630000 & 640000 
\end{array}
$$
Y por lo tanto, estimamos que:

* $\text{VPP}= 9400/51400=0.1829$

* $\text{VPN}= 588000/588600=0.999$


*(c)* ¿Y en España? Usando la fórmula de Bayes ahora con $P(E)=1/71$, obtenemos
$$
\begin{array}{rl}
\text{VPP}\!\!\!\! & =P(E|+)=\dfrac{P(+|E)\cdot P(E)}{P(+|E)\cdot P(E)+P(+|S)\cdot P(S)}\\
&= \dfrac{0.94\cdot \frac{1}{71}}{0.94\cdot \frac{1}{71}+\frac{1}{15}\cdot \frac{70}{71}}=0.1677\\[1ex]
\text{VPN} \!\!\!\!& =P(S|-)=\dfrac{P(-|S)\cdot P(S)}{P(-|S)\cdot P(S)+P(-|E)\cdot P(E)}\\
&= \dfrac{\frac{14}{15}\cdot \frac{70}{71}}{\frac{1}{15}\cdot \frac{70}{71}+0.06\cdot \frac{1}{71}}=0.9991
\end{array}
$$

* Estimamos que un 16.77% de los niños españoles que dan positivo en el test son celíacos.
* Estimamos que un 99.91% de los niños españoles que dan negativo en el test no son celíacos.


Con el método de  frecuencias naturales a partir de una población de referencia de 710,000 niños españoles, y razonando como antes, obtenemos: 

$$
\begin{array}{r|c|c|c}
& \text{Celíacos} & \text{No celíacos}  & \text{Total} \\ \hline
\text{Positivos} & 9400  &  46666.67 &  56066.67  \\ \hline
\text{Negativos} & 600  & 653333.33 &  653933.33  \\ \hline
\text{Total} &  10000 & 700000 & 710000
\end{array}
$$

Y por lo tanto, estimamos que:

* $\text{VPP}= 9400/56066.67=0.1677$

* $\text{VPN}= 653333.33/653933.33=0.9991$

En resumen:

* Sensibilidad $P(+|E)=0.94$, Especificidad $P(-|S)=14/15$

* Si la prevalencia es $P(E)=1/64$,
$$
VPP=P(E|+)=0.1829,\quad
VPN=P(S|-)=0.9990
$$

* Si la prevalencia es $P(E)=1/71$,
$$
VPP=P(E|+)=0.1677,\quad
VPN=P(S|-)=0.9991
$$

La prevalencia de la enfermedad celíaca es más pequeña en España que en Urugay, y observaréis que el VPP de la prueba de anticuerpos antiendomisio es más pequeño, y el VPN más grande, en España que en Uruguay. No es casualidad:

```{block2,type="rmdimportant"}
A mayor prevalencia, el VPP es mayor y el VPN es menor.
```

El motivo intuitivo es que si la prevalencia crece:

* Hay más enfermos, por lo que aumenta la probabilidad de encontrar enfermos y por lo tanto el VPP es mayor.
* Hay menos sanos, por lo que disminuye la probabilidad de encontrar sanos y por lo tanto  el VPN es menor.

```{block2,type="rmdcorbes"}
El motivo matemático es el siguiente. Si llamamos $x\in [0,1]$ a la prevalencia y fijamos los valores de $P(+|E),P(+|S),P(-|E),P(-|S)$, de manera que el VPP y el VPN sean una función solo de $x$, tenemos que
$$
\begin{array}{l}        
\text{VPP}(x)  =\dfrac{P(+|E)\cdot x}{P(+|E)\cdot x+P(+|S)\cdot (1-x)}\\
\text{VPN}(x) =\dfrac{P(-|S)\cdot (1-x)}{P(-|S)\cdot (1-x)+P(-|E)\cdot x}
\end{array}
$$
Y derivando, podréis comprobar que:
        
* La derivada de $\text{VPP}(x)$ sobre el intervalo [0,1]  es positiva, y por tanto  $\text{VPP}(x)$ es creciente en $x$.
        
* La derivada de $\text{VPN}(x)$ sobre el intervalo [0,1]  es negativa, y por tanto  $\text{VPP}(x)$ es decreciente en $x$.

```

En cambio, la  prevalencia no influye para nada  en la sensibilidad y la especificidad de la prueba:

* La **sensibilidad** es el porcentaje de enfermos en que la prueba da positivo, y esto es independiente de cuántos enfermos hay en la población.

* La **especificidad** es el porcentaje de sanos en que  la prueba da negativo, y esto también es independiente de cuántos individuos sanos hay en la población.

```{block2,type="rmdnote"}
La sensibilidad y la especificidad no dependen de la prevalencia, pero sí que pueden depender de otras características de una población.  Por ejemplo, en ["Findings From 752 081 Clinical Breast Examinations Reported to a National Screening Program From 1995 Through 1998"](https://academic.oup.com/jnci/article/92/12/971/2905789) (J. Bobo *et al*, *Journal of the National Cancer Institute* 92  (2000), pp. 971-976), se estimaron la especificidad y la sensibilidad del examen físico clínico del pecho como prueba diagnóstica del cáncer de mama en diversos grupos de mujeres. En la tabla siguiente recogemos algunos de los datos obtenidos en ese estudio:
        

```

$$
\begin{array}{l|ccc}
\text{Grupo} & \text{Sensibilidad} & \text{Especificidad} & \text{VPP}  \\ \hline
<40\text{ años} & 0.885 & 0.860 & 0.014  \\
40-49\text{ años} & 0.714 & 0.916 & 0.036 \\
50-59\text{ años} & 0.513 & 0.951 & 0.061 \\
60-69\text{ años} & 0.572 & 0.960 & 0.074 \\
\geq 70\text{ años} & 0.380 & 0.968 & 0.070  \\  \hline
\text{Global} & 0.588 & 0.934 & 0.043  
\end{array}
$$
Las diferencias en la sensibilidad y especificidad entre las diferentes franjas de edad se deben a las diferentes características físicas de los senos a diferentes edades, que facilitan o dificultan la detección de los  tumores, no a la prevalencia del cáncer.


```{block2,type="rmdexercici"}
Una nueva prueba de diagnóstico rápido de una enfermedad rara, de una prevalencia estimada del 0.1%, ha mostrado tener una sensibilidad del 80% y una especificidad del 60%.

*(a)* ¿Cuál es la probabilidad de que un individuo enfermo dé positivo en la prueba?

*(b)* ¿Cuál es la probabilidad  de que un individuo escogido al azar esté enfermo y al realizarle la prueba dé positivo?

*(c)* ¿Cuál es el valor predictivo negativo de esta prueba? ¿Qué significa, en lenguaje llano, el valor obtenido?

*(d)* Si la enfermedad no fuera tan rara, digamos que su prevalencia fuera del 10%, y sin realizar ningún cálculo extra, ¿qué le pasaría al  valor predictivo negativo de la prueba respecto del calculado  en el apartado anterior (aumentaría, disminuiría, se mantendría igual, no se puede saber)? Justificad brevemente vuestra respuesta.

```





Vamos a añadir algunos términos más sobre probabilidades referentes a una prueba diagnóstica:

* Su **exactitud** (**global**) es la probabilidad de acertar el diagnóstico. Es decir, $P(E\cap +)+P(S\cap -)$.

    Fijaos en que esta exactitud es igual a $P(+|E)\cdot P(E)+P(-|S)\cdot P(S)$ y por lo tanto depende de la prevalencia de la enfermedad.

* Su **cociente de verosimilitud** (*likelihood ratio*, en inglés) **positivo**, $\text{LR}(+)$, es cuántas veces es más probable  un diagnóstico positivo sobre  un enfermo  que sobre un sano. Es decir
$$
\text{LR}(+)=\dfrac{P(+|E)}{P(+|S)}=\dfrac{\text{sensibilidad}}{1-\text{especificidad}}
$$
     Un valor de $\text{LR}(+)$ por encima de 10 se toma como indicador de buen potencial diagnóstico. Por el contrario, un valor de $\text{LR}(+)$ cercano a 1 indica una prueba inútil: si dar positivo sobre un enfermo tiene aproximadamente la misma probabilidad que sobre un sano, los sucesos $+$ y $E$ son aproximadamente independientes.

* Su **cociente de verosimilitud negativo**, $\text{LR}(-)$, es cuántas veces es más probable  un diagnóstico negativo sobre un enfermo  que sobre un sano. Es decir
$$
\text{LR}(-)=\dfrac{P(-|E)}{P(-|S)}=\dfrac{1-\text{sensibilidad}}{\text{especificidad}}
$$
    Un valor de $\text{LR}(-)$ por debajo de 0.1 se toma como indicador de buen potencial para descartar la enfermedad, y un valor de $\text{LR}(-)$ cercano a 1 indica una prueba inútil en este sentido.

```{example}
Volviendo al Ejemplo \@ref(exm:antiendomisio), habíamos obtenido que

```

* Su **sensibilidad** es $P(+|E)=47/50=0.94$. Por lo tanto, su **tasa de falsos negativos** es $P(-|E)=0.06$.

* La **especificidad** es $P(-|S)= 14/15$. Por lo tanto, su **tasa de falsos positivos** es $P(+|S)=1/15$. 

* En Uruguay teníamos que $P(E)=1/64$, por lo que $P(S)=63/64$.

Entonces:

* Su **exactitud** en Uruguay es  
$$
P(E\cap +)+P(S\cap -)=P(+|E)\cdot P(E)+P(-|S)\cdot P(S)=0.94\cdot \frac{1}{64}+\frac{14}{15}\cdot \frac{63}{64}=0.9334.
$$


* Su **cociente de verosimilitud positivo** es
$$
\text{LR}(+)=\dfrac{P(+|E)}{P(+|S)}=\frac{0.94}{1/15}=14.1
$$
    y su **cociente de verosimilitud negativo** es
$$
\text{LR}(-)=\dfrac{P(-|E)}{P(-|S)}=\frac{0.06}{14/15}=0.064
$$

Los cocientes de verosimilitud se utilizan para transformar las *odds* de tener la enfermedad *a priori* (antes de realizar la prueba diagnóstica) en sus *odds* *a posteriori* (tras realizar la prueba diagnóstica). En concreto, sean:

* $\text{Odds}(E)$: las *odds* de un individuo de tener la enfermedad, antes de realizar la prueba diagnóstica.

* $\text{Odds}(E|+)$: las *odds* de un individuo de tener la enfermedad si en la prueba  da positivo.

* $\text{Odds}(E|-)$: las *odds* de un individuo de tener la enfermedad si en la prueba  da negativo.

Entonces
$$
\begin{array}{l}
\text{Odds}(E|+)=\text{Odds}(E)\cdot \text{LR}(+)\\
\text{Odds}(E|-)=\text{Odds}(E)\cdot \text{LR}(-) 
\end{array}
$$
```{block2,type="rmdcorbes"}
En efecto
$$
\begin{array}{l}
\text{Odds}(E|+)=\dfrac{P(E|+)}{P(S|+)}=\dfrac{P(E|+)P(+)}{P(S|+)P(+)}=\dfrac{P(E\cap +)}{P(S\cap +)}\\[1ex]
\text{Odds}(E)\cdot \text{LR}(+)=\dfrac{P(E)}{P(S)}\cdot \dfrac{P(+|E)}{P(+|S)}=\dfrac{P(E\cap +)}{P(S\cap +)}
\end{array}
$$
Para $\text{Odds}(E|-)$ el cálculo es similar.
```


```{example}
Se sabe que una mujer con un hermano hemofílico tiene un 50% de probabilidades de ser portadora del gen hemofilia. Una prueba genética para detectarlo tiene una sensibilidad del 90% y una especificidad del 80%. Si una mujer con hermano hemofílico se hace la prueba y da negativo, ¿cómo modifica este resultado sus *odds* de ser portadora?
        
```

Llamemos $E$ al suceso "Ser portadora". Si la mujer *a priori* tiene un 50% de probabilidades de serlo, sus *odds* son 1. Ahora sabemos que, para el test genético, $P(-|E)=0.1$ y $P(-|S)=0.8$, por lo que $\text{LR}(-)=P(-|E)/P(-|S)=\dfrac{1}{8}$.

Entonces, $\text{Odds}(E|-)=\text{Odds}(E)\cdot \text{LR}(-) =\dfrac{1}{8}$. Pasan de ser 1:1 a 1:8. Es decir, su "nueva probabilidad" de ser portadora es 1/9. 


```{block2,type="rmdexercici"}
G. Stine, en el libro "AIDS Update 1999" (Prentice Hall, 1999), explica que en 1987 se notificó a 22 donantes de sangre de Florida que habían dado positivo en un test ELISA+Western Blot de VIH, que tenía sensibilidad y  especificidad ambas del 99.99%. De ellos, 7 se suicidaron. 

La prevalencia de VIH en su sector de población (heterosexuales de bajo riesgo) se estimaba en 1 por cada 10000. ¿Cuál  era su probabilidad real de infección por VIH, sabiendo que habían dado positivo?
```




```{block2,type="rmdexercici"}
Sospechamos que un paciente tiene tuberculosis, y decidimos hacerle  un test PCR. El test concreto que vamos a usar se analizó en el estudio ["Comparative Study of a Real-Time PCR Assay Targeting senX3-regX3 versus Other Molecular Strategies Commonly Used in the Diagnosis of Tuberculosis"](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0143025), donde en un grupo de 76 muestras de pacientes cin tuberculosis confirmada y 69 muestras de control hubo 58 verdaderos positivos y 9 falsos positivos. 

*(a)* Estimad la sensibilidad, especificidad y cocientes de verosimilitud de esta prueba, y a partir de estos últimos valorad su capacidad diagnóstica.

*(b)* Por la sintomatología que presenta y la prevalencia local de la tuberculosis, asignáis *a priori* a vuestro paciente una probabilidad del 40% de tener tuberculosis. Para esta probabilidad de tener la enfermedad, calculad el VPP y el VPN de esta prueba.

*(c)* ¿Cuáles eran las *odds* de tener tuberculosis que le asignabais a este enfermo antes de realizar la prueba? Si da positivo en el test PCR, ¿cuáles son las *odds* de tener tuberculosis que le asignáis tras la prueba?

```



```{block2,type="rmdromans"}
¿Nueve palabras para describir aspectos de una prueba diagnóstica? Pues preparaos, que vienen curvas. Literalmente. Lo sentimos, una parte importante de esta asignatura es aprender el vocabulario que se usa al aplicar estadística en medicina. Ya lo dice el autor de Reglas Médicas, la medicina es un idioma.
```


```{r idioma,echo=FALSE,fig.cap="No os perdáis la magnífica *Reglas médicas* en [Twitter](https://twitter.com/ReglasM) o [Facebook](https://www.facebook.com/reglasmedicas).",out.width="50%"}
knitr::include_graphics("INREMDN_files/figure-html/idioma.png")
```


### Curvas ROC

En las secciones anteriores hemos considerado solamente pruebas binarias, que dan positivo o negativo sin ninguna gradación intermedia. Pero muchas veces una prueba diagnóstica puede dar valores en un intervalo de números reales: por ejemplo, la concentración de algún metabolito o el nivel de algún  antígeno. En este caso, lo habitual es tomar un **valor de corte** y definir como **positivo** todo valor por encima de ese valor de corte (o por debajo, va a depender de la prueba concreta) y como **negativo** lo contrario. Por ejemplo, en el diagnóstico de la diabetes por medio del nivel de glucosa en sangre en ayunas, se toma como positivo un valor por encima de un cierto umbral. En cambio, en el diagnóstico de la anemia por medio del hematocrito, se toma como positivo un valor por debajo de un cierto umbral. 

De esta manera pasamos de una prueba diagnóstica que puede tomar todo un continuo de valores a una prueba binaria como las de la sección anterior, con su sensibilidad y su especificidad. Pero ¿cómo se ha llegado a definir el valor de corte que se usa para distinguir positivo de negativo? ¿Y cómo podemos aprovechar el hecho de que la prueba nos pueda dar todo un continuo de valores?


Para simplificar el lenguaje y fijar ideas, vamos a suponer que los enfermos obtienen un valor anormalmente alto en la prueba diagnóstica, y que por lo tanto queremos definir como **positivo** cualquier valor por encima de un umbral. La prueba puede dar muchos valores, y para cada uno de ellos el test binario asociado tendrá una especificidad y una sensibilidad.

La eficacia diagnóstica global de esta prueba diagnóstica se representa gráficamente por medio de una **curva ROC** (de *Receiver Operating Characteristic*). Esta curva se obtiene de la manera siguiente:

* Tomamos varios resultados posibles $x$ de la prueba.

* Para cada uno de estos resultados $x$, consideramos el test definido tomándolo como valor de corte. Para cada uno de ellos,  sean:

    * $+_{x}$: el suceso "Dar positivo en este test" (hemos quedado en que, para fijar ideas, estos significa dar en la prueba un valor $\geq x$).
    * $-_{x}$: el suceso "Dar negativo en este test" (es decir, dar en la prueba un valor $< x$).
    * Especifidad${}_{x} = P(-_{x}|S)$: la especificidad de este test, es decir, la probabilidad de que un individuo sano dé un valor $< x$.
    * Sensibilidad${}_{x} = P(+_{x}|E)$: la sensibilidad de este test, es decir, la probabilidad de que un individuo enfermo dé un valor $\geq  x$.

* Para cada test asociado a cada umbral $x$, definimos el punto del plano real de abscisa su tasa de falsos positivos y ordenada su sensibilidad:
$$
\large(P(+_x|S),P(+_x|E)\large)=(1-\text{especificidad}_x,\text{sensibilidad}_x)
$$

* Dibujamos estos puntos y los unimos por una recta poligonal (que parecerá una curva si tomamos muchos valores de corte $x$).

El resultado es un gráfico como el siguiente:

```{r roc1,echo=FALSE,fig.cap="Una curva ROC.",out.width="50%"}
knitr::include_graphics("INREMDN_files/figure-html/roc1.png")
```

Fijaos en que, en la situación que estamos considerando en la que definimos positivo cuando el valor obtenido es **mayor** que un umbral, si $x<y$ entonces el test con umbral $y$ da menos positivos que el test con umbral $x$: todos los que dan positivo con valor de corte $y$ también dan positivo con valor de corte $x$, pero un individuo puede dar un resultado entre $x$ e $y$ y por lo tanto positivo con valor de corte $x$ y negativo con valor de corte $y$. En consecuencia, $P(+_y|S)\leq P(+_x|S)$ y  $P(+_y|E)\leq P(+_x|E)$: el punto de la curva ROC correspondiente al valor de corte $y$, $\large(P(+_y|S),P(+_y|E)\large)$, estará a la izquierda y por debajo del punto correspondiente al valor de corte  $x$, $\large(P(+_x|S),P(+_x|E)\large)$. Es decir, recorremos las curva ROC, de izquierda a derecha, en orden descendente del valor de corte.

Si hubiéramos definido positivo cuando el valor obtenido es **menor** que un umbral, entonces, cuando $x<y$, el test con umbral $y$ daría **más** positivos que el test con umbral $x$, por lo que, el punto $\large(P(+_y|S),P(+_y|E)\large)$ estaria a la derecha y por encima del punto $\large(P(+_x|S),P(+_x|E)\large)$. Es decir, recorreríamos las curva ROC, de izquierda a derecha, en orden ascendente del valor de corte.


```{example}
Vamos a dibujar una curva ROC. En el estudio ["Age-specific reference ranges for serum prostate-specific antigen in black men"](https://www.nejm.org/doi/full/10.1056/NEJM199608013350502) (T. Morgan *et al*, *New England Journal of Medicine* 335 (1996), pp. 304-310) se da la tabla siguiente con la especificidad y la sensibilidad del diagnóstico del cáncer de próstata por medio del [nivel de PSA](https://medlineplus.gov/spanish/pruebas-de-laboratorio/prueba-de-psa-antigeno-prostatico-especifico/) en diferentes poblaciones de hombres estadounidenses, definidas por razas y franjsa de edad. En esta prueba, un nivel alto de PSA puede ser señal de cáncer, y por lo tanto, en cada fila, se define como "positivo" el tener un nivel de PSA mayor o igual que el valor de su primera columna.

```


```{r tablapsaglobal,echo=FALSE,out.width="80%",fig.cap="Tabla 2 en el artículo \"Age-specific reference ranges for serum prostate-specific antigen in black men\"." }
knitr::include_graphics("INREMDN_files/figure-html/tablapsaglobal.png")
```

La curva ROC se obtiene uniendo puntos de la forma (1-especificidad,sensibilidad). Vamos a calcular estos puntos para la subpoblación de hombres blancos entre 50 y 59 años, que es la que más nos preocupa. Vamos a añadir el nivel PSA 0: como todo el mundo va a dar positivo, tendrá sensibilidad 1 y especificidad 0.

$$
\begin{array}{c|ccc}
\text{PSA} & \text{Especificidad}& 1-\text{Especificidad}& \text{Sensibilidad}\\ \hline
1 & 0 & 1 & 1 \\
1 & 0.528 & 0.472 & 0.997 \\
2 &  0.834 & 0.166 &0.994\\
3 & 0.932 & 0.068 &0.978\\
4 & 0.974 & 0.026 &0.748\\
5 & 0.987 & 0.013 &0.466\\
6 & 0.991 & 0.009 &0.261\\
7 & 1.000 & 0.000 &0.118\\
8 & 1.000  &0.000 &0.093\\
9 & 1.000  &0.000 &0.078\\
10 & 1.000 & 0.000 &0.075\\
11 & 1.000 & 0.000 &0.053\\
12 & 1.000 & 0.000 & 0.043\\
13 & 1.000 & 0.000 &0.040\\
14 & 1.000  &0.000 & 0.031\\
15 & 1.000  &0.000 & 0.025\\
\end{array}
$$

La Figura \@ref(fig:ROCama1) muestra la curva ROC que corresponde a estos valores. En ella los puntos aparecen de izquierda a derecha en orden ascendente en la tabla, es decir en orden descendente del umbral de PSA. Para ayudar en su comprensión, al lado de cada punto hemos anotado el valor de PSA al que corresponde.

```{r ROCama1,echo=FALSE,out.width="75%",fig.cap="Curva ROC del PSA entre 1 y 15 como criterio diagnótico de cáncer de próstata en hombres blancos de 50 a 59 años.",fig.asp=1.5}
X=matrix(c(1,1,
           0.472 , 0.997 ,
 0.166 ,0.994,
0.068 ,0.978,
0.026 ,0.748,
0.013 ,0.466,
0.009 ,0.261,
0.000 ,0.118,
0.000 ,0.093,
0.000 ,0.078,
0.000 ,0.075,
0.000 ,0.053,
0.000 , 0.043,
0.000 ,0.040,
0.000 , 0.031,
0.000 , 0.025),nrow=16,byrow=T)

plot(X,type="o",pch=20,xlab="1-especificidad",ylab="sensibilidad",
     xaxp=c(0,1,20),yaxp=c(0,1,20))
text(X[,1]+0.02,X[,2],col="red",cex=0.5,labels=0:15)
```


```{block2,type="rmdimportant"}
La curva ROC representa la sensibilidad de la prueba, para diferentes umbrales, en función de su tasa de falsos positivos. Es decir, si asumimos  una cierta tasa de falsos positivos, el punto de la curva ROC en la vertical de esta tasa de falsos positivos nos da la sensibilidad que obtendremos. No nos da la sensibilidad en función del valor de corte.
```


Una de las aplicaciones de la curva ROC es ayudar a decidir qué valor de corte tomar para definir el test diagnóstico binario que se va a usar en la práctica.  Una estrategia muy común es tomar el **valor de corte óptimo**: el valor $x_o$ en el que la exactitud de la prueba
$$
P(+_{x_o}|E)+P(-_{x_o}|S)=\text{sensibilidad}_{x_o}+\text{especificidad}_{x_o}
$$
sea máxima. Recordemos que, para cada punto de la curva ROC,

* Su distancia al eje vertical izquierdo $x=0$ es 1 menos la especificidad.

* Como su ordenada es la sensibilidad, su distancia a la recta horizontal $y=1$ es 1 menos la sensibilidad.

Por lo tanto, el punto que corresponda a la suma máxima de especifidad y sensibilidad  será el punto que dé la suma mínima de sus distancias a las rectas $x=0$ e $y=1$. Se trata del punto de la curva más cercano al rincón superior izquierdo $(0,1)$ del cuadrado unidad. Por ejemplo, para la curva ROC de la Figura \@ref(fig:roc1), es el indicado con una flecha en el gráfico siguiente:

```{r roc2,echo=FALSE,fig.cap="Una curva ROC y su umbral óptimo.",out.width="50%"}
knitr::include_graphics("INREMDN_files/figure-html/roc2.png")
```

En el ejemplo del PSA para hombres blancos entre 50 y 59 años, tendríamos la tabla siguiente:

$$
\begin{array}{c|ccc}
\text{PSA} & \text{Especificidad}& \text{Sensibilidad} & \text{Exactitud}\\ \hline
1 & 0.528& 0.997& 1.525 \\
2 &  0.834  &0.994& 1.828\\
\mathbf{3} & \mathbf{0.932}  &\mathbf{0.978}& \mathbf{1.910} \\
4 & 0.974  &0.748& 1.722\\
5 & 0.987  &0.466&1.453 \\
6 & 0.991  &0.261&1.252 \\
7 & 1.000  &0.118&1.118 \\
8 & 1.000 &0.093& 1.093\\
9 & 1.000  &0.078& 1.078\\
10 & 1.000  &0.075& 1.075\\
11 & 1.000  &0.053& 1.053\\
12 & 1.000  & 0.043& 1.043 \\
13 & 1.000  &0.040& 1.040\\
14 & 1.000  & 0.031& 1.031\\
15 & 1.000  & 0.025& 1.025
\end{array}
$$

El valor de corte óptimo sería entonces tomar un valor de PSA igual a 3.  En  la práctica, se toma como nivel de PSA a partir del cual uno se ha de preocupar en esa franja de edad el 4. ¿Por qué? Es un compromiso: en las pruebas de cribado se prima la especificidad, para poder descartar sanos,  y la especificidad mejora del PSA 3 al PSA 4, manteniendo aún una sensibilidad del 75%, es decir, detectando un 75% de los enfermos. 

La curva ROC también se usa para evaluar la **capacidad discriminatoria global de la prueba**, es decir, su habilidad en general para distinguir sanos de enfermos para el continuo de umbrales posibles. 

Para empezar, para que la prueba diagnóstica sirva para detectar enfermos, para cada umbral la sensibilidad ha de ser mayor que la tasa de falsos positivos (ha de dar positivo con más frecuencia en sanos que en enfermos, ¿verdad?). Esto significa que la curva ROC ha de estar por encima de la diagonal principal $y=x$. Los puntos de esta diagonal corresponden a la situación $P(+|E)=P(+|S)$. Es decir, a que el test dé positivo con la misma frecuencia en sanos que en enfermos y por lo tanto "estar enfermo" y "dar positivo" sean sucesos independientes. En este caso el test no sirve para nada. En el contexto de las curvas ROC, a la diagonal principal del cuadrado unidad se la llama  la **línea de no discriminación** por este motivo.

```{example}
Imaginaos que queremos diagnosticar una enfermedad mediante el lanzamiento de dados. Lanzas 5 dados, anotas el resultado y si supera un cierto umbral, da positivo. El estar enfermo o sano no influye para nada en el resultado del lanzamiento, por lo que para todo umbral $x$ que consideremos, la probabilidad de superar ese umbral si se está sano y si se está enfermo es la misma: $P(+_x|E)=P(+_x|S)$. La curva ROC de esta prueba diagnóstica sería la diagonal principal del cuadrado unidad,   la línea de no discriminación.


```


Como hemos comentado, un valor de la prueba es mejor cuanto más se acerca su punto de la curva ROC al extremo superior izquierdo del cuadrado unidad. Por lo tanto, cuanto más se se separe una curva ROC de la línea de no discriminación por encima de la misma y más se aproxime al ángulo que forman las rectas $x=0$ e $y=1$, mejor es la prueba globalmente. Por ejemplo, en la Figura \@ref(fig:roc3), la curva ROC con puntos rellenos corresponde a una prueba diagnóstica con mayor capacidad discriminatoria que la de los puntos vacíos.


```{r roc3,echo=FALSE,fig.cap="Dos curvas ROC.",out.width="50%"}
knitr::include_graphics("INREMDN_files/figure-html/roc3.png")
```


La **capacidad discriminatoria global** de una prueba diagnóstica se mide con su **Área Bajo la Curva ROC** (abreviada **AUC**, de *area under the curve*,  en inglés). Este valor es, como su nombre indica, el área comprendida por la curva ROC, el eje de abscisas $y=0$ y la recta vertical $x=1$. Representa el **valor promedio de la sensibilidad** para todos los valores de corte de la prueba 

```{block2,type="rmdcorbes"}
Los que visteis integrales en Matemáticas II del Bachillerato tendríais que recordar que esta área se obtiene integrando entre 0 y 1 la función que define la curva, y que la integral dividida por la longitud de la base, que en este caso es 1, es el valor promedio de la función sobre el intervalo. Por lo tanto, para ser precisos, la AUC es el **valor promedio de la sensibilidad como función de la tasa de falsos positivos**, pero tampoco importa hilar tan fino.
```

Así:

* AUC=0.5 es la de la línea de no discriminación. Si una  curva ROC tiene AUC=0.5, consideramos que la prueba diagnóstica es inútil.

* AUC=1 solo es posible si la curva ROC es la recta $y=1$, es decir, si todos los valores de corte tienen sensibilidad 1, que querría decir que nunca se equivoca  sobre un enfermo.

```{example}
En el estudio ["Proteína C reactiva y lactato deshidrogenasa en el diagnóstico de la obstrucción intestinal en un servicio de urgencias"](http://scielo.isciii.es/pdf/asisna/v39n1/13_original_breve4.pdf)
(R. Rodríguez *et al*, *Anales del Sistema Sanitario de Navarra* 39 (2016), pp. 115-122) se compararon dos técnicas analíticas de diagnóstico de la obstrucción intestinal: los niveles de la proteína C reactiva (PCR) y del enzima lactato deshidrogenasa (LDH) en plasma.

```

La Figura \@ref(fig:rocnavarra) muestra las curvas ROC de ambos tests, con sus valores de AUC y los valores de corte óptimos marcados. La AUC para la prueba de la PCR es 0.8 y la de la prueba del LDH es 0.86. Por lo tanto, la primera prueba tiene globalmente una mayor capacidad discriminatoria que la otra. Además, tomando como positivo a partir de los valores de corte óptimos en cada test, el nivel de LDH tiene especificidad y sensibilidad mayores: su punto de su curva ROC está más arriba y más a la izquierda que el otro.


```{r rocnavarra,echo=FALSE,fig.cap="Curvas ROC en la Figura 1 del artículo \"Proteína C reactiva y lactato deshidrogenasa en el diagnóstico de la obstrucción intestinal en un servicio de urgencias\".",out.width="90%"}
knitr::include_graphics("INREMDN_files/figure-html/rocnavarra.png")
```



